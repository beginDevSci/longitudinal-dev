{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Statistical Analysis Section - Flexible Blocks (v2)",
  "description": "Simplified block-based system with 4 types: code, output, interpretation, viewer. Author controls exact ordering with zero constraints.",

  "type": "object",
  "required": ["content_blocks"],

  "properties": {
    "content_blocks": {
      "type": "array",
      "description": "Ordered sequence of content blocks. Author has complete control over order and quantity. No validation constraints on relationships between blocks.",
      "minItems": 1,
      "maxItems": 50,
      "items": {
        "oneOf": [
          { "$ref": "#/definitions/CodeBlock" },
          { "$ref": "#/definitions/OutputBlock" },
          { "$ref": "#/definitions/InterpretationBlock" },
          { "$ref": "#/definitions/ViewerBlock" }
        ]
      }
    }
  },

  "definitions": {
    "CodeBlock": {
      "type": "object",
      "required": ["type", "data"],
      "description": "Code snippet block for displaying R, Python, Julia, or other programming language code. Can appear any number of times in any position.",
      "properties": {
        "type": {
          "const": "code",
          "description": "Block type discriminator"
        },
        "data": {
          "type": "object",
          "required": ["title", "content"],
          "properties": {
            "title": {
              "type": "string",
              "minLength": 1,
              "description": "Code block title describing the code's purpose",
              "examples": [
                "Primary Model Specification",
                "Model Diagnostics",
                "Sensitivity Analysis",
                "Data Preparation",
                "Post-hoc Comparisons"
              ]
            },
            "content": {
              "type": "string",
              "minLength": 1,
              "description": "The actual code content",
              "examples": [
                "model <- glmer(y ~ x + (1|id), data = df, family = poisson)",
                "import pandas as pd\ndf = pd.read_csv('data.csv')",
                "using DataFrames\nmodel = fit(MixedModel, @formula(y ~ x + (1|id)), data)"
              ]
            },
            "language": {
              "type": "string",
              "default": "r",
              "description": "Programming language identifier for syntax highlighting. Defaults to 'r' if not specified.",
              "examples": ["r", "python", "julia", "bash", "sql", "stata", "sas"]
            },
            "filename": {
              "type": "string",
              "description": "Optional source filename reference for context",
              "examples": ["model.R", "diagnostics.py", "prepare_data.jl", "analysis.do"]
            },
            "default_open": {
              "type": "boolean",
              "default": false,
              "description": "Whether the code block should be expanded by default on page load. If false or omitted, the block starts collapsed. Useful for showing key code sections without requiring user interaction.",
              "examples": [true, false]
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },

    "OutputBlock": {
      "type": "object",
      "required": ["type", "data"],
      "description": "Output/result block for displaying console output, tables, or images (plots/diagrams). Can appear any number of times in any position.",
      "properties": {
        "type": {
          "const": "output",
          "description": "Block type discriminator"
        },
        "data": {
          "type": "object",
          "required": ["content"],
          "properties": {
            "content": {
              "type": "string",
              "minLength": 1,
              "description": "Output content. Interpretation depends on format field:\n- format='text': Raw console output (displayed in preformatted code block)\n- format='table': HTML table markup or delimited table data\n- format='image': Image URL or file path (absolute or relative)",
              "examples": [
                "Fixed effects:\n  (Intercept) -2.304 (SE=0.052)\n  time         0.123 (SE=0.009)\n  \nRandom effects:\n  Groups   Variance Std.Dev.\n  id       0.234    0.484",
                "/images/posts/glmm/diagnostics.png",
                "https://example.com/plots/predicted_trajectories.png",
                "<table><tr><th>Model</th><th>AIC</th><th>BIC</th></tr><tr><td>Poisson</td><td>5234</td><td>5298</td></tr></table>"
              ]
            },
            "format": {
              "type": "string",
              "enum": ["text", "table", "image"],
              "default": "text",
              "description": "Output format for rendering:\n- 'text': Preformatted console output\n- 'table': Tabular data (HTML or CSV/TSV format)\n- 'image': Plot, diagram, or screenshot"
            },
            "alt": {
              "type": "string",
              "description": "Accessibility alt text. Strongly recommended when format='image' for screen reader support.",
              "examples": [
                "Diagnostic plots showing residuals vs predicted values and QQ plot",
                "Predicted alcohol use trajectories with 95% confidence intervals by age",
                "Model comparison bar chart showing AIC values for three competing models"
              ]
            },
            "caption": {
              "type": "string",
              "description": "Optional caption displayed below output. Useful for images and tables to provide context.",
              "examples": [
                "Figure 1: Model diagnostic plots indicate assumptions are satisfied",
                "Table 1: Model comparison using information criteria",
                "Figure 2: Predicted trajectories show 13% annual increase"
              ]
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },

    "InterpretationBlock": {
      "type": "object",
      "required": ["type", "data"],
      "description": "Interpretation block for explaining the meaning and significance of analysis outputs. Renders as a visually distinct callout card to highlight key interpretations. Can appear any number of times in any position.",
      "properties": {
        "type": {
          "const": "note",
          "description": "Block type discriminator (uses 'note' for backward compatibility)"
        },
        "data": {
          "type": "object",
          "required": ["title", "content"],
          "properties": {
            "title": {
              "type": "string",
              "minLength": 1,
              "description": "Interpretation heading or label",
              "examples": [
                "Interpretation",
                "Clinical Significance",
                "Model Comparison Results",
                "Effect Size Interpretation",
                "Practical Implications"
              ]
            },
            "content": {
              "type": "string",
              "minLength": 1,
              "description": "Interpretation body text explaining the meaning or significance of results. Can be multiple paragraphs.",
              "examples": [
                "The time coefficient of 0.123 indicates a 13% annual increase in alcohol use (exp(0.123) â‰ˆ 1.13). This represents a concerning developmental trend during early adolescence.",
                "The significant random slope variance (0.234) suggests substantial individual differences in trajectories. Some youth show steeper increases than the average trend.",
                "The Poisson model shows better fit (AIC=5234) compared to the negative binomial alternative (AIC=5298), suggesting that overdispersion is not a major concern in this dataset."
              ]
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },

    "ViewerBlock": {
      "type": "object",
      "required": ["type", "data"],
      "description": "Interactive viewer block for WebGPU-powered 3D visualizations (e.g., brain surfaces). Shows static fallback when WebGPU is unavailable. Requires webgpu-viewer feature flag for full interactivity.",
      "properties": {
        "type": {
          "const": "viewer",
          "description": "Block type discriminator"
        },
        "data": {
          "type": "object",
          "required": ["manifest_path"],
          "properties": {
            "manifest_path": {
              "type": "string",
              "minLength": 1,
              "description": "Path to the viewer manifest JSON file that describes available surfaces, analyses, contrasts, and default settings.",
              "examples": [
                "/data/blmm/manifest.json",
                "/data/viewers/cortical_thickness/manifest.json"
              ]
            },
            "overrides": {
              "type": "object",
              "description": "Optional override values for this viewer instance. These take precedence over defaults in the manifest.",
              "properties": {
                "analysis": {
                  "type": "string",
                  "description": "Analysis design to display (e.g., 'des1', 'des2')"
                },
                "statistic": {
                  "type": "string",
                  "description": "Statistic type to display (e.g., 'conT', 'conTlp', 'beta', 'sigma2')"
                },
                "volume_idx": {
                  "type": "integer",
                  "minimum": 0,
                  "description": "Contrast/volume index (0-based)"
                },
                "colormap": {
                  "type": "string",
                  "description": "Colormap name (e.g., 'coolwarm', 'viridis')"
                },
                "threshold": {
                  "type": "number",
                  "description": "Threshold value for display (e.g., 2.0 for |t| > 2)"
                },
                "hemisphere": {
                  "type": "string",
                  "enum": ["lh", "rh", "both"],
                  "description": "Hemisphere to display"
                }
              },
              "additionalProperties": false
            },
            "caption": {
              "type": "string",
              "description": "Optional caption displayed below the viewer",
              "examples": [
                "Interactive BLMM t-statistics viewer. Explore different contrasts and analysis designs.",
                "Cortical thickness mapped onto the brain surface. Use controls to rotate and zoom."
              ]
            },
            "fallback_image": {
              "type": "string",
              "description": "Static fallback image path shown when WebGPU is unavailable or viewer initialization fails",
              "examples": [
                "/stage4-artifacts/blmm-interpreting-results/dual_hemisphere.png",
                "/images/viewers/cortical_thickness_static.png"
              ]
            },
            "fallback_alt": {
              "type": "string",
              "description": "Alt text for the fallback image (accessibility)",
              "examples": [
                "Static BLMM t-statistics for both hemispheres",
                "Cortical thickness visualization (static fallback)"
              ]
            },
            "auto_start": {
              "type": "boolean",
              "default": false,
              "description": "If true, initialize viewer immediately on page load. If false (default), show 'Load 3D Viewer' button to avoid loading heavy WebGPU code unnecessarily."
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    }
  },

  "additionalProperties": false
}
